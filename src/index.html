<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="apple-touch-icon" href="assets/icons/icon-512x512.png">
  <link rel="apple-touch-icon" sizes="152x152" href="assets/icons/icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="assets/icons/icon-192x192.png">
  <link rel="apple-touch-icon" sizes="167x167" href="assets/icons/icon-192x192.png">
  <title>GRAYLL</title>
  <base href="/">

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <link href="https://fonts.googleapis.com/css?family=Nunito:400,700&amp;display=swap" rel="stylesheet">
  <link href="./assets/gg-map.css" rel="stylesheet">
  <link rel="manifest" href="manifest.json">
  <link rel='manifest' href='/manifest.webmanifest'>
  <meta name="theme-color" content="#1976d2">
  <script>
    /*
    if ("serviceWorker" in navigator) {
      if (navigator.serviceWorker.controller) {
        console.log("[PWA Builder] active service worker found, no need to register");
      } else {
        // Register the service worker
        navigator.serviceWorker
          .register("pwabuilder-sw.js", {
            scope: "./"
          })
          .then(function (reg) {
            console.log("[PWA Builder] Service worker has been registered for scope: " + reg.scope);
          });
      }
    }
    */
  </script>

</head>

<body>
  <app-root></app-root>
  <!--<div id="map"></div>-->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCWYPAmKwjM1sv4nFYB4m7dCAqN0dcOXsI"></script>
  <script>
    function CustomMarker(opts) {
      this.setValues(opts);
    }
    CustomMarker.prototype = new google.maps.OverlayView();


    CustomMarker.prototype.draw = function() {
      var self = this;
      var div = this.div;
      if (!div) {
        div = this.div = document.createElement("div");
        div.classList.add("marker-container");
        this.div.classList.add("marker-container");
        div.innerHTML = this.div.innerHTML= `<div class="ring-container">
        <div class="ringring"></div>
        <div class="circle"></div>
    </div>`;

        this.pinWrap = this.div.getElementsByClassName('pin-wrap');
        this.pin = this.div.getElementsByClassName('pin');
        this.pinShadow = this.div.getElementsByClassName('shadow');
        div.style.position = 'absolute';
        div.style.cursor = 'pointer';
        var panes = this.getPanes();
        panes.overlayImage.appendChild(div);
        google.maps.event.addDomListener(div, "click", function(event) {
          google.maps.event.trigger(self, "click", event);
        });
      }
      var point = this.getProjection().fromLatLngToDivPixel(this.position);
      if (point) {
        div.style.left = point.x + 'px';
        div.style.top = point.y + 'px';
      }
    };




    let map, infoWindow;

    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: -34.397, lng: 150.644 },
        zoom: 18,
      });
      infoWindow = new google.maps.InfoWindow();

      let markers =[];
      function pointToCurrentLocation() {
        // Try HTML5 geolocation.
        let marker;
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            (position) => {
              const pos = {
                lat: position.coords.latitude,
                lng: position.coords.longitude,
              };
              infoWindow.setContent("Runner Location");
              map.setCenter(pos);
              if(markers.length){
                for(let i=0;i<markers.length;i++){
                  markers[i].setMap(null);
                  markers[i]=null;
                }
                document.querySelectorAll(".marker-container").forEach(()=>this.remove())
                markers=[]
              }
              // marker = new google.maps.Marker({
              //   position: pos,
              //   map: map,
              //   draggable: true,
              //   // icon:"icons/green.png"
              // });
              var marker = new CustomMarker({
                position: pos,
                map: map,
                draggable: true,
              });
              markers.push(marker);

              infoWindow.open({
                anchor: marker,
                position: pos,
                map,
                shouldFocus: false
              });

              marker.addListener("click", () => {
                infoWindow.open({
                  anchor: marker,
                  map,
                  shouldFocus: false
                });
              });

            },
            () => {
              handleLocationError(true, infoWindow, map.getCenter());
            }
          );
        } else {
          // Browser doesn't support Geolocation
          handleLocationError(false, infoWindow, map.getCenter());
        }
      }
      pointToCurrentLocation();
      setInterval(() => {
        pointToCurrentLocation();
      }, 10000);
    }

    function handleLocationError(browserHasGeolocation, infoWindow, pos) {
      infoWindow.setPosition(pos);
      infoWindow.setContent(
        browserHasGeolocation
          ? "Error: The Geolocation service failed."
          : "Error: Your browser doesn't support geolocation."
      );
      infoWindow.open(map);
    }
    initMap();
  </script>
  <script>
    window.intercomSettings = {
      app_id: "v9vzre42",
      //app_id: "qu23mgu1",
    };
  </script>
  <script>
  // We pre-filled your app ID in the widget URL: 'https://widget.intercom.io/widget/v9vzre42'
  (function(){var w=window;var ic=w.Intercom;if(typeof ic==="function"){ic('reattach_activator');ic('update',w.intercomSettings);}else{var d=document;var i=function(){i.c(arguments);};i.q=[];i.c=function(args){i.q.push(args);};w.Intercom=i;var l=function(){var s=d.createElement('script');s.type='text/javascript';s.async=true;s.src='https://widget.intercom.io/widget/v9vzre42';var x=d.getElementsByTagName('script')[0];x.parentNode.insertBefore(s,x);};if(w.attachEvent){w.attachEvent('onload',l);}else{w.addEventListener('load',l,false);}}})();
  </script>
  <noscript>Please enable JavaScript to continue using this application.</noscript>
</body>

</html>
