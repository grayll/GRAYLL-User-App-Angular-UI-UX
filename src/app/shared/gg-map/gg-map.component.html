<div id="map"></div>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCWYPAmKwjM1sv4nFYB4m7dCAqN0dcOXsI"></script>
<script>
  function CustomMarker(opts) {
    this.setValues(opts);
  }
  CustomMarker.prototype = new google.maps.OverlayView();


  CustomMarker.prototype.draw = function() {
    var self = this;
    var div = this.div;
    if (!div) {
      div = this.div = document.createElement("div");
      div.classList.add("marker-container");
      this.div.classList.add("marker-container");
      div.innerHTML = this.div.innerHTML= `<div class="ring-container">
        <div class="ringring"></div>
        <div class="circle"></div>
    </div>`;

      this.pinWrap = this.div.getElementsByClassName('pin-wrap');
      this.pin = this.div.getElementsByClassName('pin');
      this.pinShadow = this.div.getElementsByClassName('shadow');
      div.style.position = 'absolute';
      div.style.cursor = 'pointer';
      var panes = this.getPanes();
      panes.overlayImage.appendChild(div);
      google.maps.event.addDomListener(div, "click", function(event) {
        google.maps.event.trigger(self, "click", event);
      });
    }
    var point = this.getProjection().fromLatLngToDivPixel(this.position);
    if (point) {
      div.style.left = point.x + 'px';
      div.style.top = point.y + 'px';
    }
  };




  let map, infoWindow;

  function initMap() {
    map = new google.maps.Map(document.getElementById("map"), {
      center: { lat: -34.397, lng: 150.644 },
      zoom: 18,
    });
    infoWindow = new google.maps.InfoWindow();

    let markers =[];
    function pointToCurrentLocation() {
      // Try HTML5 geolocation.
      let marker;
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (position) => {
            const pos = {
              lat: position.coords.latitude,
              lng: position.coords.longitude,
            };
            infoWindow.setContent("Runner Location");
            map.setCenter(pos);
            if(markers.length){
              for(let i=0;i<markers.length;i++){
                markers[i].setMap(null);
                markers[i]=null;
              }
              document.querySelectorAll(".marker-container").forEach(()=>this.remove())
              markers=[]
            }
            // marker = new google.maps.Marker({
            //   position: pos,
            //   map: map,
            //   draggable: true,
            //   // icon:"icons/green.png"
            // });
            var marker = new CustomMarker({
              position: pos,
              map: map,
              draggable: true,
            });
            markers.push(marker);

            infoWindow.open({
              anchor: marker,
              position: pos,
              map,
              shouldFocus: false
            });

            marker.addListener("click", () => {
              infoWindow.open({
                anchor: marker,
                map,
                shouldFocus: false
              });
            });

          },
          () => {
            handleLocationError(true, infoWindow, map.getCenter());
          }
        );
      } else {
        // Browser doesn't support Geolocation
        handleLocationError(false, infoWindow, map.getCenter());
      }
    }
    pointToCurrentLocation();
    setInterval(() => {
      pointToCurrentLocation();
    }, 10000);
  }

  function handleLocationError(browserHasGeolocation, infoWindow, pos) {
    infoWindow.setPosition(pos);
    infoWindow.setContent(
      browserHasGeolocation
        ? "Error: The Geolocation service failed."
        : "Error: Your browser doesn't support geolocation."
    );
    infoWindow.open(map);
  }
  initMap();
</script>
